server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # SPA routing
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Proxy API (cos√¨ la UI chiama /api senza CORS)
  # Media/static in produzione non vengono serviti da Django (DEBUG=0),
  # quindi li inoltriamo al backend_nginx che li espone tramite alias.
  location /api/media/ {
    proxy_pass http://backend_nginx;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout  10s;
    proxy_send_timeout    130s;
    proxy_read_timeout    130s;
  }

  location /api/static/ {
    proxy_pass http://backend_nginx;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_connect_timeout  10s;
    proxy_send_timeout    130s;
    proxy_read_timeout    130s;
  }

  # NOTE: Drive downloads use X-Accel-Redirect which is handled by backend_nginx
  # (it has the internal /protected_media/ location + access rules for /api/media/drive/).
  # Therefore the whole /api/ namespace must pass through backend_nginx.
  location /api/ {
    proxy_pass http://backend_nginx;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeout allineati al --timeout 120 di gunicorn (+ margine di 10s).
    # Senza questi, nginx chiude la connessione dopo 60s di default
    # causando un 502 Bad Gateway su richieste lente (import, batch, ecc.).
    proxy_connect_timeout  10s;
    proxy_send_timeout    130s;
    proxy_read_timeout    130s;
  }
}

