server {
    listen 8080;
    server_name backend_nginx;

    # NOTE:
    # Keep this aligned with the backend upload limits (Drive).
    client_max_body_size 25m;

    # ----------------------------------------------------------------------
    # Media
    # ----------------------------------------------------------------------
    # Public media (avatars, etc.) is served by nginx.
    # Drive files are **blocked** here and must be accessed through the
    # authenticated API endpoints (/api/drive-files/:id/download|preview).

    # Prevent bypassing Drive ACLs via direct media URLs
    location ^~ /api/media/drive/ {
        return 404;
    }

    location /api/media/ {
        alias /media/;
        autoindex off;
    }

    # Optional: internal location for X-Accel-Redirect (future optimization)
    # Django can return: X-Accel-Redirect: /protected_media/<relative_path>
    location ^~ /protected_media/ {
        internal;
        alias /media/;
        autoindex off;
    }

    # ----------------------------------------------------------------------
    # API (Django)
    # ----------------------------------------------------------------------
    location / {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
